# Ptobot Backend

Этот проект — минимальный бэкенд на FastAPI для сбора отчётов с фотографиями и интеграции с Telegram-ботом. Ниже — пошаговое описание для новичка: как устроены файлы, как запустить и как расширять.

## 1. Что здесь есть
```
app/
  main.py               # Создаёт FastAPI-приложение, регистрирует роутеры и запускает бота
  core/                 # Конфигурация и логирование
  api/                  # Роутеры FastAPI и зависимости для DI
  models/               # Pydantic-схемы запросов/ответов
  repositories/         # Хранилища данных (пока in-memory)
  services/             # Бизнес-логика и интеграции
  infrastructure/       # Низкоуровневые клиенты (S3)
main.py                 # Удобная точка входа для uvicorn/app
bot.py                  # Отдельный запуск Telegram-бота
requirements.txt        # Список зависимостей
start.sh                # Пример команды запуска uvicorn
```

## 2. Быстрый запуск API
1. Установите зависимости (рекомендуется виртуальное окружение):
   ```bash
   pip install -r requirements.txt
   ```
2. Создайте файл `.env` или задайте переменные окружения (см. раздел ниже). Для локального запуска можно оставить значения по умолчанию и просто не указывать ключи S3/бота.
3. Запустите сервер FastAPI:
   ```bash
   uvicorn app.main:app --reload
   ```
4. Откройте Swagger-документацию: http://127.0.0.1:8000/docs

## 3. Запуск Telegram-бота отдельно
Если токен бота задан, он стартует автоматически вместе с API. Для отдельного запуска:
```bash
python bot.py
```

## 4. Главные файлы по порядку
- `app/main.py` — создаёт приложение, вешает CORS, подключает роутеры `/`, `/work_types`, `/reports` и на событиях `startup/shutdown` запускает/останавливает бот.  
- `app/api/routers/root.py` — отдаёт состояние сервера и ссылки на основные эндпоинты.  
- `app/api/routers/work_types.py` — возвращает список видов работ из репозитория.  
- `app/api/routers/reports.py` — принимает форму с данными отчёта и файлами, сохраняет фото в S3 и кладёт отчёт в память; также отдаёт список отчётов с фильтрами по `user_id` и `work_type_id`.  
- `app/api/deps.py` — фабрики зависимостей: настройки, репозитории, сервисы. Используется FastAPI `Depends` и кэширование через `lru_cache`.  
- `app/core/config.py` — читает настройки из окружения (название приложения, S3, токен бота, лимит отчётов).  
- `app/services/storage_service.py` — принимает файлы `UploadFile`, генерирует имя и кладёт в Yandex Object Storage через boto3, возвращая публичный URL.  
- `app/services/report_service.py` — бизнес-логика: загружает фото, формирует `Report` с timestamp, сохраняет в репозиторий и фильтрует отчёты.  
- `app/repositories/work_type_repo.py` — предзаполненный список видов работ в памяти.  
- `app/repositories/report_repo.py` — deque с ограничением `max_reports`, выдаёт новые id через счётчик.  
- `app/infrastructure/yandex_s3.py` — создаёт low-level клиент boto3 для S3.  
- `bot.py` — минимальный aiogram-бот с кнопкой для открытия webapp (URL из `WEBAPP_URL`).

## 5. Переменные окружения
| Имя | Описание |
| --- | --- |
| `APP_TITLE` | Название приложения (по умолчанию `Ptobot backend`). |
| `YC_S3_ENDPOINT` | Endpoint S3 (по умолчанию `https://storage.yandexcloud.net`). |
| `YC_S3_REGION` | Регион S3 (по умолчанию `ru-central1`). |
| `YC_S3_BUCKET` или `YANDEX_BUCKET` | Имя бакета для отчётов. |
| `YC_S3_ACCESS_KEY_ID` | Access key Yandex Cloud. |
| `YC_S3_SECRET_ACCESS_KEY` | Secret key Yandex Cloud. |
| `BOT_TOKEN` | Токен Telegram-бота; если не задан, бот не стартует. |
| `MAX_REPORTS` | Максимум хранимых отчётов в памяти (по умолчанию 500). |
| `WEBAPP_URL` | URL фронтенда, который открывает бот (по умолчанию https://reports-frontend.onrender.com). |

## 6. Что доработать дальше
- Подключить настоящую БД вместо хранения в памяти.
- Добавить авторизацию и валидацию входных данных (например, проверять, что `work_type_id` существует).
- Написать автотесты для сервисов и роутеров.
- Вынести конфигурацию CORS/логирования в настройки, добавить структуры для разных окружений.
